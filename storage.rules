rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Função para verificar quota baseada no plano (Free: 10MB, Pro: 50MB)
    function hasSpaceAvailable(userId) {
      let userPath = /databases/(default)/documents/users/$(userId);
      
      // Se o documento do usuário não existir ou não tiver dados de uso, assume 0
      let userExists = firestore.exists(userPath);
      let userData = userExists ? firestore.get(userPath).data : {};
      
      let usage = ('storage_usage_bytes' in userData) ? userData.storage_usage_bytes : 0;
      let subscription = ('subscription' in userData) ? userData.subscription : 'free';
      
      // Define limites (em bytes)
      // Pro/Trial: 50MB, Free: 10MB
      let limit = (subscription == 'pro' || subscription == 'trial') ? 52428800 : 10485760;
      
      // Permite se o uso atual for menor que o limite
      // (Isso permite que o último arquivo ultrapasse ligeiramente, comportamento padrão para evitar bloqueios rígidos em updates pequenos)
      return usage < limit;
    }

    // Firmwares: Auth para upload (Admin - embora não definido explicitamente aqui, qualquer auth logado pode ler)
    // A regra original permitia write para qualquer auth logado, mantendo a fidelidade ao arquivo original.
    match /firmwares/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Default: Deny
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Regras para upload de relatórios 
    // Estrutura: reports/{userId}/{reportId}/attachments/{filename}
    match /reports/{userId}/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId && hasSpaceAvailable(userId);
    }

    // Regras para configurações de usuário e assinaturas
    // Estrutura: settings/{userId}/{filename}
    match /settings/{userId}/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId && hasSpaceAvailable(userId);
    }
  }
}